<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大连理工大学选课系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-mortarboard-fill me-2"></i>大连理工大学选课系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="/"><i class="bi bi-house"></i> 主页</a></li>
                    <li class="nav-item"><a class="nav-link" href="/auto_select"><i class="bi bi-lightning"></i> 自动抢课</a></li>
                    <li class="nav-item"><a class="nav-link" href="/monitor"><i class="bi bi-eye"></i> 余量监控</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-3"><i class="bi bi-check-circle"></i> 已登录</span>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="refreshCache()"><i class="bi bi-arrow-clockwise"></i> 刷新缓存</button>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row g-4">
            <!-- 搜索课程 -->
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-search text-primary me-2"></i>搜索课程</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">课程名称</label>
                            <input type="text" class="form-control" id="courseName" placeholder="输入课程名称">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">校区</label>
                            <select class="form-select" id="campusSelect">
                                <option value="">全部校区</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100" onclick="searchCourse()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                        <div id="searchResults" class="mt-3" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- 已选课程 -->
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-bookmark-check text-success me-2"></i>已选课程</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="getSelectedCourses()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="selectedCourses" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const toastEl = document.getElementById('toast');
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });

        window.onload = function() {
            getSelectedCourses();
            loadCampuses();
        };

        async function loadCampuses() {
            try {
                const response = await fetch('/get_campuses');
                const result = await response.json();
                if (result.success) {
                    const select = document.getElementById('campusSelect');
                    result.campuses.forEach(campus => {
                        const option = document.createElement('option');
                        option.value = campus;
                        option.textContent = campus;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载校区失败:', error);
            }
        }

        function showMessage(text, isError = false) {
            document.getElementById('toastIcon').className = isError ? 'bi bi-x-circle text-danger me-2' : 'bi bi-check-circle text-success me-2';
            document.getElementById('toastTitle').textContent = isError ? '错误' : '成功';
            document.getElementById('toastBody').textContent = text;
            toast.show();
        }

        async function logout() {
            if (!confirm('确定要退出登录吗？')) return;
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                showMessage('退出失败: ' + error.message, true);
            }
        }

        async function refreshCache() {
            try {
                const response = await fetch('/refresh_lesson_cache');
                const result = await response.json();
                showMessage(result.message, !result.success);
            } catch (error) {
                showMessage('刷新缓存失败: ' + error.message, true);
            }
        }

        async function searchCourse() {
            const courseName = document.getElementById('courseName').value;
            const campus = document.getElementById('campusSelect').value;
            
            if (!courseName) {
                showMessage('请输入课程名称', true);
                return;
            }

            try {
                const response = await fetch('/search_course', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_name: courseName, campus: campus })
                });

                const result = await response.json();
                if (result.success) {
                    displaySearchResults(result.courses);
                } else {
                    showMessage(result.message, true);
                }
            } catch (error) {
                showMessage('搜索失败: ' + error.message, true);
            }
        }

        function displaySearchResults(courses) {
            const resultsDiv = document.getElementById('searchResults');
            if (courses.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1"></i><p>未找到相关课程</p></div>';
                return;
            }

            let html = '<div class="list-group">';
            courses.forEach(course => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${course.name} <small class="text-muted">${course.code}</small></h6>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> ${course.teachers} &nbsp;
                                    <i class="bi bi-geo-alt"></i> ${course.campus} &nbsp;
                                    <i class="bi bi-star"></i> ${course.credits}学分
                                </small>
                                <div class="mt-1">
                                    <span class="badge bg-secondary">容量: ${course.capacity}</span>
                                    <span class="badge bg-info">已选: ${course.selected || '0'}</span>
                                    <small class="text-muted ms-2">ID: ${course.id}</small>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="selectCourse(${course.id})">
                                <i class="bi bi-plus-lg"></i> 选课
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function selectCourse(classId) {
            try {
                const response = await fetch('/select_course', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: classId })
                });

                const result = await response.json();
                showMessage(result.message, !result.success);
                if (result.success) {
                    getSelectedCourses();
                }
            } catch (error) {
                showMessage('选课失败: ' + error.message, true);
            }
        }

        async function dropCourse(classId) {
            if (!confirm('确定要退课吗？')) return;

            try {
                const response = await fetch('/drop_course', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: classId })
                });

                const result = await response.json();
                showMessage(result.message, !result.success);
                if (result.success) {
                    getSelectedCourses();
                }
            } catch (error) {
                showMessage('退课失败: ' + error.message, true);
            }
        }

        async function getSelectedCourses() {
            try {
                const response = await fetch('/selected_courses');
                const result = await response.json();
                
                if (result.success) {
                    displaySelectedCourses(result.courses);
                } else {
                    showMessage(result.message, true);
                }
            } catch (error) {
                showMessage('获取已选课程失败: ' + error.message, true);
            }
        }

        function displaySelectedCourses(courses) {
            const selectedDiv = document.getElementById('selectedCourses');
            if (courses.length === 0) {
                selectedDiv.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1"></i><p>暂无已选课程</p></div>';
                return;
            }

            let html = '<div class="list-group">';
            courses.forEach(course => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${course.name} <small class="text-muted">${course.code}</small></h6>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> ${course.teachers} &nbsp;
                                    <i class="bi bi-geo-alt"></i> ${course.campus} &nbsp;
                                    <i class="bi bi-star"></i> ${course.credits}学分
                                </small>
                                <div class="mt-1">
                                    <span class="badge bg-secondary">容量: ${course.capacity}</span>
                                    <span class="badge bg-info">已选: ${course.selected || '0'}</span>
                                </div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="dropCourse(${course.id})">
                                <i class="bi bi-trash"></i> 退课
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            selectedDiv.innerHTML = html;
        }

        document.getElementById('courseName').addEventListener('keypress', e => {
            if (e.key === 'Enter') searchCourse();
        });
    </script>
</body>
</html>
