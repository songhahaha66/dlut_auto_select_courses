<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½™é‡ç›‘æ§ - å¤§è¿ç†å·¥å¤§å­¦é€‰è¯¾ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-mortarboard-fill me-2"></i>å¤§è¿ç†å·¥å¤§å­¦é€‰è¯¾ç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house"></i> ä¸»é¡µ</a></li>
                    <li class="nav-item"><a class="nav-link" href="/auto_select"><i class="bi bi-lightning"></i> è‡ªåŠ¨æŠ¢è¯¾</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/monitor"><i class="bi bi-eye"></i> ä½™é‡ç›‘æ§</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <h3 class="text-primary mb-0" id="totalCourses">0</h3>
                        <small class="text-muted">ç›‘æ§è¯¾ç¨‹</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <h3 class="text-success mb-0" id="availableCourses">0</h3>
                        <small class="text-muted">æœ‰ä½™é‡</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <h3 class="text-info mb-0" id="checkCount">0</h3>
                        <small class="text-muted">æ£€æŸ¥æ¬¡æ•°</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <h3 class="text-warning mb-0" id="successCount">0</h3>
                        <small class="text-muted">æˆåŠŸé€‰è¯¾</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- æœç´¢è¯¾ç¨‹ -->
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-search text-primary me-2"></i>æœç´¢è¯¾ç¨‹</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">è¯¾ç¨‹åç§°</label>
                            <input type="text" class="form-control" id="search_input" placeholder="è¾“å…¥è¯¾ç¨‹åç§°...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ ¡åŒºç­›é€‰</label>
                            <select class="form-select" id="campus_filter">
                                <option value="">æ‰€æœ‰æ ¡åŒº</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100" onclick="searchCourses()">
                            <i class="bi bi-search"></i> æœç´¢è¯¾ç¨‹
                        </button>
                        <div id="search_results" class="mt-3" style="max-height: 350px; overflow-y: auto;">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1"></i>
                                <p>è¯·æœç´¢è¯¾ç¨‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç›‘æ§è®¾ç½® -->
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-gear text-primary me-2"></i>ç›‘æ§è®¾ç½®</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-success" onclick="startMonitoring()" id="startBtn">
                                <i class="bi bi-play-fill"></i> å¼€å§‹ç›‘æ§
                            </button>
                            <button class="btn btn-warning" onclick="stopMonitoring()" id="stopBtn" disabled>
                                <i class="bi bi-pause-fill"></i> åœæ­¢
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearMonitorList()">
                                <i class="bi bi-trash"></i> æ¸…ç©º
                            </button>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label class="form-label">æ£€æŸ¥é—´éš” (ç§’)</label>
                                <input type="number" class="form-control" id="interval" value="3" min="1" max="30">
                            </div>
                            <div class="col-6 d-flex align-items-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoSelect" checked>
                                    <label class="form-check-label" for="autoSelect">å‘ç°ä½™é‡è‡ªåŠ¨é€‰è¯¾</label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="monitor_list" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1"></i>
                                <p>æš‚æ— ç›‘æ§è¯¾ç¨‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç›‘æ§æ—¥å¿— -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-terminal text-primary me-2"></i>ç›‘æ§æ—¥å¿—</h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                    <i class="bi bi-trash"></i> æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
            <div class="card-body p-0">
                <pre id="log_display" class="bg-dark text-light p-3 mb-0" style="max-height: 250px; overflow-y: auto; font-size: 13px;"></pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let monitorCourses = [];
        let isMonitoring = false;
        let monitorInterval = null;
        let logHistory = [];
        let checkCount = 0;
        let successCount = 0;

        document.addEventListener('DOMContentLoaded', function() {
            loadCampuses();
            updateMonitorList();
            initLogDisplay();
        });

        async function loadCampuses() {
            try {
                const response = await fetch('/get_campuses');
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('campus_filter');
                    data.campuses.forEach(campus => {
                        const option = document.createElement('option');
                        option.value = campus;
                        option.textContent = campus;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ ¡åŒºå¤±è´¥:', error);
            }
        }

        async function searchCourses() {
            const courseName = document.getElementById('search_input').value.trim();
            const campus = document.getElementById('campus_filter').value;
            
            if (!courseName) {
                alert('è¯·è¾“å…¥è¯¾ç¨‹åç§°');
                return;
            }
            
            try {
                const response = await fetch('/search_course', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({course_name: courseName, campus: campus})
                });
                
                const data = await response.json();
                if (data.success) {
                    showCourses(data.courses);
                } else {
                    alert('æœç´¢å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('æœç´¢å‡ºé”™: ' + error.message);
            }
        }

        function showCourses(courses) {
            const container = document.getElementById('search_results');

            if (courses.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1"></i><p>æœªæ‰¾åˆ°è¯¾ç¨‹</p></div>';
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            courses.forEach(course => {
                const availableSpots = course.capacity - parseInt(course.selected);
                const statusClass = availableSpots > 0 ? 'text-success' : 'text-danger';
                const statusText = availableSpots > 0 ? `ä½™é‡: ${availableSpots}` : 'å·²æ»¡';

                // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªé€‰è¯¾ç»„
                const scheduleGroups = course.scheduleGroups || [];
                const hasMultipleGroups = scheduleGroups.length > 1;

                // ç”Ÿæˆé€‰è¯¾ç»„é€‰æ‹©å™¨HTML
                let groupSelectorHtml = '';
                if (hasMultipleGroups) {
                    groupSelectorHtml = `
                        <div class="mt-2">
                            <label class="form-label small"><i class="bi bi-calendar-check"></i> é€‰æ‹©é€‰è¯¾ç»„:</label>
                            <select class="form-select form-select-sm" id="scheduleGroup_${course.id}">
                                ${scheduleGroups.map((group, idx) => `
                                    <option value="${group.id}" ${group.default ? 'selected' : ''}>
                                        ç»„${group.no + 1}: ${group.timeText || 'æ—¶é—´å¾…å®š'} (å®¹é‡:${group.limitCount})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                } else if (scheduleGroups.length === 1) {
                    // åªæœ‰ä¸€ä¸ªé€‰è¯¾ç»„ï¼Œæ˜¾ç¤ºæ—¶é—´å¹¶åˆ›å»ºéšè—çš„selectå­˜å‚¨ID
                    const group = scheduleGroups[0];
                    groupSelectorHtml = `
                        <div class="mt-1">
                            <small class="text-muted"><i class="bi bi-calendar-check"></i> æ—¶é—´: ${group.timeText || 'æ—¶é—´å¾…å®š'}</small>
                            <select class="d-none" id="scheduleGroup_${course.id}">
                                <option value="${group.id}" selected></option>
                            </select>
                        </div>
                    `;
                }

                html += `
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${course.name} <small class="text-muted">${course.code}</small></h6>
                                <div class="text-secondary small text-truncate" style="max-width: 280px;" title="${course.className || ''}"><i class="bi bi-people"></i> ${course.className || ''}</div>
                                <small class="text-muted">${course.teachers} | ${course.campus} | ${course.selected}/${course.capacity}</small>
                                ${groupSelectorHtml}
                            </div>
                            <div class="text-end">
                                <span class="badge ${availableSpots > 0 ? 'bg-success' : 'bg-danger'} mb-1">${statusText}</span><br>
                                <button class="btn btn-primary btn-sm" onclick="addToMonitor(${course.id}, '${course.name}', '${course.code}', '${course.teachers}', '${course.campus}', ${course.capacity}, ${hasMultipleGroups})">
                                    <i class="bi bi-plus"></i> ç›‘æ§
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function addToMonitor(courseId, courseName, courseCode, teachers, campus, capacity, hasMultipleGroups = false) {
            if (monitorCourses.find(course => course.id === courseId)) {
                alert('è¯¥è¯¾ç¨‹å·²åœ¨ç›‘æ§åˆ—è¡¨ä¸­');
                return;
            }

            let scheduleGroupId = null;
            // ä»é€‰è¯¾ç»„é€‰æ‹©å™¨è·å–é€‰ä¸­çš„IDï¼ˆæ— è®ºå•ä¸ªè¿˜æ˜¯å¤šä¸ªé€‰è¯¾ç»„ï¼‰
            const selectElement = document.getElementById(`scheduleGroup_${courseId}`);
            if (selectElement) {
                scheduleGroupId = parseInt(selectElement.value);
            }

            monitorCourses.push({
                id: courseId, name: courseName, code: courseCode,
                teachers: teachers, campus: campus, capacity: capacity,
                selected: 0, available: 0, lastCheck: null,
                schedule_group_id: scheduleGroupId
            });

            updateMonitorList();
            updateStats();
        }

        function updateMonitorList() {
            const container = document.getElementById('monitor_list');

            if (monitorCourses.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1"></i><p>æš‚æ— ç›‘æ§è¯¾ç¨‹</p></div>';
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            monitorCourses.forEach((course, index) => {
                const hasAvailable = course.available > 0;
                const statusText = course.lastCheck ? `${course.selected}/${course.capacity} (ä½™é‡: ${course.available})` : 'æœªæ£€æŸ¥';
                const scheduleGroupText = course.schedule_group_id ? `<br><small class="text-info">é€‰è¯¾ç»„ID: ${course.schedule_group_id}</small>` : '';

                html += `
                    <div class="list-group-item px-0 ${hasAvailable ? 'list-group-item-success' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${course.name}</strong>
                                ${hasAvailable ? '<span class="badge bg-success ms-2">æœ‰ä½™é‡</span>' : ''}
                                <br><small class="text-muted">ID: ${course.id} | ${course.teachers}</small>
                                ${scheduleGroupText}
                                <br><small class="${hasAvailable ? 'text-success' : 'text-muted'}">${statusText}</small>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeFromMonitor(${index})" ${isMonitoring ? 'disabled' : ''}>
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function removeFromMonitor(index) {
            if (isMonitoring) return;
            monitorCourses.splice(index, 1);
            updateMonitorList();
            updateStats();
        }

        function clearMonitorList() {
            if (isMonitoring) return;
            monitorCourses = [];
            updateMonitorList();
            updateStats();
        }

        function startMonitoring() {
            if (monitorCourses.length === 0) {
                alert('è¯·å…ˆæ·»åŠ è¦ç›‘æ§çš„è¯¾ç¨‹');
                return;
            }
            
            isMonitoring = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            addLog('ğŸš€ å¼€å§‹ç›‘æ§è¯¾ç¨‹ä½™é‡...');
            checkCourses();
        }

        function stopMonitoring() {
            isMonitoring = false;
            if (monitorInterval) {
                clearTimeout(monitorInterval);
                monitorInterval = null;
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            addLog('â¸ï¸ ç›‘æ§å·²åœæ­¢');
        }

        async function checkCourses() {
            if (!isMonitoring) return;
            
            try {
                checkCount++;
                updateStats();
                
                const courseIds = monitorCourses.map(course => course.id);
                const response = await fetch('/check_course_availability', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({course_ids: courseIds})
                });
                
                const data = await response.json();
                if (data.success) {
                    monitorCourses.forEach(course => {
                        course.lastCheck = new Date().toLocaleTimeString();
                        const availableCourse = data.available_courses.find(ac => ac.id === course.id);
                        if (availableCourse) {
                            course.selected = availableCourse.selected;
                            course.available = availableCourse.available;
                        } else {
                            course.available = 0;
                        }
                    });
                    
                    updateMonitorList();
                    updateStats();
                    
                    if (data.available_courses.length > 0) {
                        addLog(`ğŸŸ¢ å‘ç° ${data.available_courses.length} é—¨è¯¾ç¨‹æœ‰ä½™é‡!`);
                        
                        if (document.getElementById('autoSelect').checked) {
                            for (const course of data.available_courses) {
                                addLog(`ğŸ¯ å°è¯•è‡ªåŠ¨é€‰è¯¾: ${course.name}`);
                                await attemptAutoSelect(course.id, course.name);
                            }
                        } else {
                            data.available_courses.forEach(course => {
                                addLog(`ğŸ’¡ ${course.name} æœ‰ ${course.available} ä¸ªä½™é‡`);
                            });
                        }
                    } else {
                        addLog(`ğŸ” æ£€æŸ¥å®Œæˆï¼Œæš‚æ— ä½™é‡`);
                    }
                } else {
                    addLog(`âŒ æ£€æŸ¥å¤±è´¥: ${data.message}`);
                }
                
            } catch (error) {
                addLog(`âŒ æ£€æŸ¥å‡ºé”™: ${error.message}`);
            }
            
            if (isMonitoring) {
                const interval = parseInt(document.getElementById('interval').value) * 1000;
                monitorInterval = setTimeout(checkCourses, interval);
            }
        }

        async function attemptAutoSelect(courseId, courseName) {
            try {
                // æŸ¥æ‰¾ç›‘æ§è¯¾ç¨‹ä»¥è·å–é€‰è¯¾ç»„ID
                const monitorCourse = monitorCourses.find(course => course.id === courseId);
                const requestBody = {class_id: courseId};

                // å¦‚æœæœ‰é€‰è¯¾ç»„IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (monitorCourse && monitorCourse.schedule_group_id) {
                    requestBody.schedule_group_id = monitorCourse.schedule_group_id;
                }

                const response = await fetch('/select_course', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (data.success) {
                    successCount++;
                    updateStats();
                    addLog(`ğŸ‰ è‡ªåŠ¨é€‰è¯¾æˆåŠŸ: ${courseName}`);

                    const index = monitorCourses.findIndex(course => course.id === courseId);
                    if (index !== -1) {
                        monitorCourses.splice(index, 1);
                        updateMonitorList();
                        updateStats();
                    }
                } else {
                    addLog(`âŒ è‡ªåŠ¨é€‰è¯¾å¤±è´¥: ${courseName} - ${data.message}`);
                }
            } catch (error) {
                addLog(`âŒ è‡ªåŠ¨é€‰è¯¾å‡ºé”™: ${courseName} - ${error.message}`);
            }
        }

        function updateStats() {
            document.getElementById('totalCourses').textContent = monitorCourses.length;
            const availableCount = monitorCourses.filter(course => course.available > 0).length;
            document.getElementById('availableCourses').textContent = availableCount;
            document.getElementById('checkCount').textContent = checkCount;
            document.getElementById('successCount').textContent = successCount;
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logHistory.push(`[${timestamp}] ${message}`);
            if (logHistory.length > 100) logHistory.shift();
            
            const logDiv = document.getElementById('log_display');
            logDiv.textContent = logHistory.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function initLogDisplay() {
            logHistory = ['ç­‰å¾…å¼€å§‹ç›‘æ§...'];
            document.getElementById('log_display').textContent = logHistory.join('\n');
        }

        function clearLogs() {
            logHistory = ['æ—¥å¿—å·²æ¸…ç©º'];
            document.getElementById('log_display').textContent = logHistory.join('\n');
        }

        document.getElementById('search_input').addEventListener('keypress', e => {
            if (e.key === 'Enter') searchCourses();
        });
    </script>
</body>
</html>
